<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Grid Splitter - A powerful tool for splitting and managing grid layouts. Create, customize and export grid templates with ease. Perfect for web designers and developers.">
    <meta name="keywords" content="grid splitter, grid layout, web design tool, css grid generator, layout builder">
    <meta name="theme-color" content="#AAFF42">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Grid Splitter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --inchworm:#AAFF42;
            --inchworm-complement:#B573FF;
            --gunmetal:#1E2D2C;
            --gunmetal-complement:#2D1E1F;
            --orange:#FF7A2F;
            --orange-complement:#2FB8FF;
            --pale-violet:#B2A1FF;
            --pale-violet-complement:#EEFFB2;
            --bright-snow:#FFFFFF;
            --bright-snow-complement:#000000;
            --american-silver:#D1D1D1;
            --american-silver-complement:#2E2E2E;
            
            /* Modern UI Colors */
            --lime-green: #AAFF42;
            --dark-navy: #141C2F;
            --navy-blue: #1E293B;
            --purple: #8B5CF6;
            --coral: #FF6B4A;
            
            /* Theme Colors */
            --primary:#C4FF5A;
            --primary-complement:var(--purple);
            --secondary:var(--purple);
            --secondary-complement:var(--pale-violet-complement);
            --tertiary:var(--coral);
            --tertiary-complement:var(--orange-complement);
            --accent:var(--lime-green);
            --accent-complement:var(--purple);
            
            /* Dark Theme */
            --background-start:#141C2F;
            --background-end:#1E293B;
            --background-overlay:rgba(30,41,59,0.95);
            --background-base:#141C2F;
            --surface-base:#1E293B;
            --surface-light:rgba(255,255,255,0.07);
            --surface-medium:rgba(255,255,255,0.04);
            --surface-dark:#273549;
            --surface-lighter:#1E293B;
            --surface-darker:#141C2F;
            --card-bg:#1E293B;
            --card-shadow:0 10px 30px -5px rgba(0,0,0,0.3),0 8px 15px -6px rgba(0,0,0,0.2);
            --text-primary:#f8fafc;
            --text-secondary:#cbd5e1;
            --text-tertiary:#94a3b8;
            --text-accent:var(--lime-green);
            --text-active:var(--lime-green);
            --text-inactive:#64748b;
            --border:rgba(255,255,255,0.1);
            --error:#f43f5e;
            --warning:var(--coral);
            --success:var(--lime-green);
            --info:var(--purple);
            --primary-rgb:170,255,66
        }
        
        [data-theme="light"]{
            --primary:var(--orange);
            --primary-complement:var(--purple);
            --secondary:var(--purple);
            --secondary-complement:var(--pale-violet-complement);
            --tertiary:var(--coral);
            --tertiary-complement:var(--orange-complement);
            --accent:var(--lime-green);
            --accent-complement:var(--purple);
            --background-start:#f8fafc;
            --background-end:#f1f5f9;
            --background-overlay:rgba(255,255,255,0.95);
            --background-base:var(--bright-snow);
            --surface-base:var(--bright-snow);
            --surface-light:rgba(0,0,0,0.03);
            --surface-medium:rgba(0,0,0,0.06);
            --surface-dark:#e2e8f0;
            --surface-lighter:#f8fafc;
            --surface-darker:#e2e8f0;
            --card-bg:var(--bright-snow);
            --card-shadow:0 10px 30px -5px rgba(0,0,0,0.05),0 8px 15px -6px rgba(0,0,0,0.02);
            --text-primary:#1e293b;
            --text-secondary:#475569;
            --text-tertiary:#64748b;
            --text-accent:var(--lime-green);
            --text-active:var(--lime-green);
            --text-inactive:var(--american-silver);
            --border:rgba(0,0,0,0.08);
            --error:#dc2626;
            --warning:var(--coral);
            --success:var(--lime-green);
            --info:var(--purple);
            --primary-rgb:170,255,66
        }
        *{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
        body{
            background:linear-gradient(135deg,var(--background-start),var(--background-end));
            color:var(--text-primary);
            min-height:100vh;
            padding:0;
            margin:0;
            transition:background 0.5s ease,color 0.3s ease;
            background-image: url('avatar_grid_1.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        .app-container{
            max-width:1400px;
            margin:0 auto;
            padding:1.5rem 1rem;
            background-color: rgba(20, 28, 47, 0.85);
            border-radius: 1rem;
            backdrop-filter: blur(5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;position:relative}
        h1{
            font-size:2.5rem;
            font-weight:700;
            color:var(--primary);
            text-align:center;
            margin:0 auto;
            letter-spacing:-0.5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        .main-content{display:grid;grid-template-columns:1fr;gap:1.25rem;margin-bottom:100px;}
        @media (min-width:1024px){.main-content{grid-template-columns:1fr 1fr;gap:1.25rem}}
        .panel{background:var(--card-bg);border-radius:1rem;padding:1.25rem;box-shadow:var(--card-shadow);backdrop-filter:blur(10px);transition:all 0.3s ease;height:fit-content}
        .panel-title{font-size:1.1rem;font-weight:600;margin-bottom:1rem;color:var(--text-primary);display:flex;align-items:center;gap:0.5rem}
        .panel-title svg{stroke:var(--primary)}
        .upload-container{display:flex;flex-direction:column;align-items:center;gap:1.25rem}
        .upload-area{width:50%;aspect-ratio:1/1;border:2px dashed var(--border);border-radius:0.75rem;display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;padding:1rem;background-color:var(--surface-darker);transition:all 0.3s ease;position:relative;overflow:hidden}
        .upload-area:hover{border-color:var(--primary);background-color:var(--surface-light);transform:scale(1.01)}
        .upload-icon{width:3rem;height:3rem;stroke:var(--primary);margin-bottom:1rem;opacity:0.8}
        .upload-text{font-size:0.9rem;color:var(--text-secondary);text-align:center;max-width:90%}
        .preview-image{max-width:100%;max-height:100%;object-fit:contain;border-radius:0.75rem}
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:0.5rem;padding:0.75rem 1.25rem;border-radius:0.5rem;font-weight:600;font-size:0.95rem;cursor:pointer;transition:all 0.3s ease;border:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);margin:10px;}
        .btn-primary{background:var(--primary);color:var(--surface-darker);}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,0.15);filter:brightness(1.05)}
        .btn-secondary{background:var(--purple);color:white}
        .btn-secondary:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,0.15);filter:brightness(1.05)}
        .btn-tertiary{background:var(--coral);color:white}
        .btn-tertiary:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,0.15);filter:brightness(1.05)}
        .grid-controls{background:var(--surface-darker);border-radius:0.75rem;padding:1rem;margin-bottom:1rem;box-shadow:inset 0 2px 4px rgba(0,0,0,0.1)}
        .grid-input{display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
        .input-group{display:flex;flex-direction:column;gap:0.4rem}
        .grid-input input{width:80px;padding:0.6rem;border:1px solid var(--border);border-radius:0.5rem;text-align:center;background-color:var(--surface-base);color:var(--text-primary);font-size:1rem;font-weight:500;transition:border-color 0.2s}
        .grid-input label{font-size:0.9rem;font-weight:500;color:var(--text-secondary)}
        .container{position:relative;margin:0 auto;background-color:var(--surface-darker);border:1px solid var(--border);border-radius:0.75rem;overflow:hidden;box-shadow:var(--card-shadow);width:100%}
        .grid-container{position:relative;width:100%;height:100%}
        .grid-line{position:absolute;z-index:10;transition:background-color 0.2s ease}
        .horizontal-line{width:100%;height:1px;cursor:row-resize;border-top:2px dashed var(--accent);margin-top:0;background-color:transparent;transition:border 0.2s ease;pointer-events:auto;z-index:50}
        .horizontal-line:hover{border-top:2px solid var(--primary);background-color:transparent;height:1px;margin-top:0}
        .vertical-line{height:100%;width:1px;cursor:col-resize;border-left:2px dashed var(--accent);margin-left:0;background-color:transparent;transition:border 0.2s ease;pointer-events:auto;z-index:50}
        .vertical-line:hover{border-left:2px solid var(--primary);background-color:transparent;width:1px;margin-left:0}
        .grid-cell{position:absolute;background-size:cover;background-position:center;border:none;transition:all 0.2s ease;z-index:5}
        .cell-download{position:absolute;right:12px;top:12px;background-color:var(--surface-base);color:var(--primary);border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        .grid-cell:hover .cell-download{opacity:1;transform:scale(1.1) rotate(5deg)}
        .cell-download:hover{background-color:var(--primary);color:white;transform:scale(1.2) rotate(5deg)!important}
        .cell-number{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background-color:var(--surface-darker);color:var(--text-primary);border-radius:0.75rem;padding:0.75rem 1.25rem;font-size:1rem;font-weight:600;opacity:0;transition:opacity 0.3s,transform 0.3s;pointer-events:none;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
        .grid-cell:hover .cell-number{opacity:1;transform:translate(-50%,-50%) scale(1.1)}
        .no-image{display:flex;flex-direction:column;justify-content:center;align-items:center;background-color:var(--surface-light);border:2px dashed var(--border);color:var(--text-secondary);border-radius:0.75rem;height:100%;width:100%;gap:1rem}
        .show-all-downloads .cell-download{opacity:1}
        
        /* Mobile improvements for cell interactions */
        @media (pointer:coarse) {
            .grid-cell:active .cell-number {
                opacity:1;
                transform:translate(-50%,-50%) scale(1.1);
            }
            .grid-cell .cell-download {
                opacity:0.8;
                width:50px;
                height:50px;
            }
            .cell-download svg {
                width:20px;
                height:20px;
            }
            .horizontal-line, .vertical-line{
                border-width:3px;
            }
            .horizontal-line:hover, .vertical-line:hover{
                border-width:3px;
            }
        }
        
        /* Mobile device class enhancements */
        .mobile-device .grid-cell .cell-download {
            opacity:0.8;
            transform:scale(1);
        }
        
        /* Active state for touch devices */
        .mobile-device .btn:active {
            transform:scale(0.97);
        }
        
        #loading-indicator{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:var(--background-overlay);z-index:1000;justify-content:center;align-items:center;flex-direction:column;backdrop-filter:blur(8px)}
        .loading-spinner{width:80px;height:80px;margin-bottom:2rem;position:relative}
        .loading-spinner:before,.loading-spinner:after{content:'';position:absolute;border-radius:50%;animation:ripple 2s ease-out infinite;top:0;left:0;width:100%;height:100%}
        .loading-spinner:before{border:4px solid var(--primary-complement)}
        .loading-spinner:after{border:4px solid var(--primary);animation-delay:1s}
        @keyframes ripple{0%{transform:scale(0.4);opacity:1}100%{transform:scale(1.8);opacity:0}}
        .loading-text{color:var(--text-primary);font-size:1.5rem;font-weight:600;margin-bottom:0.75rem;animation:pulse 2s infinite}
        .loading-subtext{color:var(--text-secondary);font-size:1rem}
        @keyframes pulse{0%{opacity:0.6}50%{opacity:1}100%{opacity:0.6}}
        .theme-toggle{position:fixed;top:2rem;right:2rem;background:linear-gradient(135deg,var(--surface-base),var(--surface-lighter));color:var(--text-primary);width:54px;height:54px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,0.15);z-index:100;border:none;transition:all 0.4s ease;font-size:1.5rem}
        .theme-toggle:hover{transform:scale(1.15) rotate(15deg);background:linear-gradient(135deg,var(--primary),var(--primary-complement));color:var(--bright-snow);box-shadow:0 8px 25px rgba(0,0,0,0.2)}
        .grid-dimensions{display:flex;align-items:center;justify-content:center;background-color:var(--surface-darker);padding:0.6rem 1rem;border-radius:0.5rem;margin-top:1rem;box-shadow:inset 0 1px 2px rgba(0,0,0,0.1)}
        .grid-dimensions span{font-size:1rem;font-weight:600;color:var(--text-tertiary)}
        .grid-dimensions strong{color:var(--primary);font-weight:700;font-size:1.25rem;margin:0 0.35rem}
        .tips-box{margin-top:1.25rem;padding:1rem;background-color:var(--surface-darker);border-left:3px solid var(--purple);border-radius:0.5rem;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
        .tips-box h3{font-size:0.95rem;color:var(--text-primary);margin-bottom:0.6rem;display:flex;align-items:center;gap:0.5rem}
        .tips-box p{font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.4rem}
        .tips-box ul{padding-left:1.5rem;margin-top:0.5rem}
        .tips-box li{font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.4rem}
        
        .download-container{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-top:1rem}
        @media (max-width:768px){
            .app-container{padding:1rem 0.75rem}
            h1{font-size:1.75rem}
            .panel{padding:1rem}
            .grid-input{flex-direction:column;align-items:flex-start;gap:0.75rem}
            .input-group{width:100%;flex-direction:row;align-items:center;justify-content:space-between}
            .grid-input input{width:100px}
            .download-container{grid-template-columns:1fr}
            .tips-box h3{font-size:0.9rem}
            .tips-box li{font-size:0.8rem}
            .upload-area{width:100%;aspect-ratio:1/1}
            .upload-text{font-size:0.8rem}
            .btn{padding:0.65rem 1rem;font-size:0.9rem}
            .sample-image{max-width:100%}
        }
        
        /* Additional mobile optimizations */
        @media (max-width:480px){
            h1{font-size:1.5rem}
            .panel{padding:0.75rem;border-radius:0.75rem}
            .panel-title{font-size:1rem}
            .grid-input input{width:80px}
            .btn{padding:0.6rem 0.9rem;font-size:0.85rem}
            .grid-dimensions span{font-size:0.9rem}
            .grid-dimensions strong{font-size:1.1rem}
            .theme-toggle{top:1rem;right:1rem;width:48px;height:48px}
        }
        
        @media (max-width: 480px) {
            .btn {
                margin: 5px;
                padding: 0.65rem 1rem;
                width: 100%; 
                max-width: 100%;
            }
            .download-container {
                grid-template-columns: 1fr;
                grid-gap: 0.5rem;
            }
        }
        
        .sample-section {
            margin-top: 1rem;
            text-align: center;
        }
        .sample-title {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .sample-image {
            max-width: 50%;
            border-radius: 0.75rem;
            box-shadow: var(--card-shadow);
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .sample-image:hover {
            transform: scale(1.02);
        }
        .sample-caption {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle color theme">
        <span id="theme-icon">🌙</span>
    </button>
    
    <div class="app-container">
        <header>
            <h1>Grid Splitter</h1>
        </header>
        
        <main class="main-content">
            <section class="panel">
                <h2 class="panel-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    Image Upload
                </h2>
                <div class="upload-container">
                    <div id="image-preview" class="upload-area">
                        <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <p class="upload-text">Drag and drop your image here, or click to browse</p>
                    </div>
                    
                    <button id="upload-btn" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Upload Image
                    </button>
                    <input type="file" id="file-input" style="display: none" accept="image/*">
                </div>
                
                <div class="grid-controls">
                    <div class="grid-input">
                        <div class="input-group">
                            <label for="rows">Rows:</label>
                            <input type="number" id="rows" min="1" max="10" value="3">
                        </div>
                        <div class="input-group">
                            <label for="columns">Columns:</label>
                            <input type="number" id="columns" min="1" max="10" value="3">
                        </div>
                        <button id="split-btn" class="btn btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="3" y1="9" x2="21" y2="9"></line>
                                <line x1="3" y1="15" x2="21" y2="15"></line>
                                <line x1="9" y1="3" x2="9" y2="21"></line>
                                <line x1="15" y1="3" x2="15" y2="21"></line>
                            </svg>
                            Create Grid
                        </button>
                    </div>
                    <div id="grid-dimensions" class="grid-dimensions" style="display: none;">
                        <span>Current grid: <strong id="current-rows">3</strong> × <strong id="current-cols">3</strong></span>
                    </div>
                </div>

               
                <div class="tips-box">
                    <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        Tips
                    </h3>
                    <ul>
                        <li>Drag the grid lines to customize your layout</li>
                        <li>Hover over a cell to see its position</li>
                        <li>Click the download button on a cell to save just that portion</li>
                        <li>Use "Download All Images" to get everything as a ZIP file</li>
                    </ul>
                </div>
                 <!-- Sample Grid Image Section -->
              <div class="sample-section">
                <div class="sample-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="3" y1="9" x2="21" y2="9"></line>
                        <line x1="3" y1="15" x2="21" y2="15"></line>
                        <line x1="9" y1="3" x2="9" y2="21"></line>
                        <line x1="15" y1="3" x2="15" y2="21"></line>
                    </svg>
                    Sample Grid
                </div>
                <div id="sample-container">
                    <div class="sample-caption">Click below to use a sample grid</div>
                    <button id="sample-btn" class="btn btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                            <line x1="3" y1="15" x2="21" y2="15"></line>
                            <line x1="9" y1="3" x2="9" y2="21"></line>
                            <line x1="15" y1="3" x2="15" y2="21"></line>
                        </svg>
                        Use Sample Grid
                    </button>
                </div>
            </div>
            </section>

             
            
            
            <section id="preview-panel" class="panel" style="display: none;">
                <h2 class="panel-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="3" y1="9" x2="21" y2="9"></line>
                        <line x1="9" y1="21" x2="9" y2="9"></line>
                    </svg>
                    Grid Preview
                </h2>
                
                <div id="container" class="container">
                    <div id="grid-container" class="grid-container"></div>
                </div>
                
                <div id="download-container" class="download-container">
                    <button id="download-all-btn" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download All Images
                    </button>
                    <button id="show-downloads-btn" class="btn btn-tertiary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                        </svg>
                        Show Download Buttons
                    </button>
                </div>
            </section>
        </main>
    </div>
    
    <div id="loading-indicator">
        <div class="loading-spinner"></div>
        <div class="loading-text">Preparing your images...</div>
        <div class="loading-subtext">This may take a moment</div>
    </div>
    
    <script>
        // DOM elements
        const fileInput = document.getElementById('file-input');
        const uploadBtn = document.getElementById('upload-btn');
        const imagePreview = document.getElementById('image-preview');
        const rowsInput = document.getElementById('rows');
        const columnsInput = document.getElementById('columns');
        const splitBtn = document.getElementById('split-btn');
        const container = document.getElementById('container');
        const gridContainer = document.getElementById('grid-container');
        const downloadAllBtn = document.getElementById('download-all-btn');
        const showDownloadsBtn = document.getElementById('show-downloads-btn');
        const downloadContainer = document.getElementById('download-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const gridDimensions = document.getElementById('grid-dimensions');
        const currentRows = document.getElementById('current-rows');
        const currentCols = document.getElementById('current-cols');
        const sampleContainer = document.getElementById('sample-container');
        const previewPanel = document.getElementById('preview-panel');
        
        // Global variables
        let uploadedImage = null;
        let horizontalLines = [];
        let verticalLines = [];
        let showAllDownloads = false;
        let isMobileDevice = false;
        
        // Check if the device is mobile
        function checkMobileDevice() {
            isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
            document.body.classList.toggle('mobile-device', isMobileDevice);
            return isMobileDevice;
        }
        
        // Initial mobile check
        checkMobileDevice();
        
        // Update on resize
        window.addEventListener('resize', function() {
            checkMobileDevice();
            
            // If grid is already visible, resize it responsively
            if (previewPanel.style.display !== 'none' && uploadedImage) {
                adjustGridForCurrentScreen();
            }
        });
        
        function adjustGridForCurrentScreen() {
            const isMobile = window.innerWidth <= 768;
            const newWidth = isMobile ? Math.min(window.innerWidth - 40, 600) : 600;
            
            if (newWidth !== window.gridRenderWidth) {
                // Recalculate grid with new dimensions
                createGrid(true);
            }
        }
        
        // Theme handling
        const THEME_PREFERENCE_KEY = 'grid_maker_theme_preference';
        
        // Check for saved theme or use system preference
        function initTheme() {
            const savedTheme = localStorage.getItem(THEME_PREFERENCE_KEY);
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
                updateThemeIcon(savedTheme);
            } else {
                // Check system preference
                const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
                if (prefersDarkScheme.matches) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    updateThemeIcon('dark');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                    updateThemeIcon('light');
                }
            }
        }
        
        function updateThemeIcon(theme) {
            themeIcon.textContent = theme === 'dark' ? '☀️' : '🌙';
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem(THEME_PREFERENCE_KEY, newTheme);
            updateThemeIcon(newTheme);
        }
        
        // Initialize theme
        initTheme();
        
        // Event listeners
        uploadBtn.addEventListener('click', () => fileInput.click());
        imagePreview.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileUpload);
        splitBtn.addEventListener('click', function() {
            // Make sure we're using the current input values
            const rows = parseInt(rowsInput.value) || 3;
            const columns = parseInt(columnsInput.value) || 3;
            
            // Update UI to reflect the current values
            currentRows.textContent = rows;
            currentCols.textContent = columns;
            
            // Create grid with current values
            createGrid(false);
        });
        downloadAllBtn.addEventListener('click', downloadAllCells);
        showDownloadsBtn.addEventListener('click', toggleDownloadButtons);
        themeToggle.addEventListener('click', toggleTheme);
        
        // Setup drag and drop for image upload
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            imagePreview.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            imagePreview.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            imagePreview.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            imagePreview.style.borderColor = 'var(--primary)';
            imagePreview.style.backgroundColor = 'var(--surface-medium)';
        }
        
        function unhighlight() {
            imagePreview.style.borderColor = 'var(--border)';
            imagePreview.style.backgroundColor = 'var(--surface-lighter)';
        }
        
        imagePreview.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            handleFile(file);
        }
        
        // Handle file upload
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) handleFile(file);
        }
        
        function handleFile(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                uploadedImage = new Image();
                uploadedImage.onload = function() {
                    // Clear previous preview
                    imagePreview.innerHTML = '';
                    imagePreview.classList.remove('no-image');
                    
                    // Create preview image
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.className = 'preview-image';
                    imagePreview.appendChild(img);
                    
                    // Update the image preview appearance
                    imagePreview.style.padding = '0';
                    imagePreview.style.border = 'none';
                    imagePreview.style.backgroundColor = 'transparent';
                };
                uploadedImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Create the grid
        function createGrid(isResize = false) {
            if (!uploadedImage) {
                alert('Please upload an image first');
                return;
            }
            
            // Get user input
            let rows, columns;
            
            if (isResize) {
                // Keep existing grid dimensions for resize
                rows = parseInt(currentRows.textContent) || 3;
                columns = parseInt(currentCols.textContent) || 3;
            } else {
                // Use input values for new grid
                rows = parseInt(rowsInput.value) || 3;
                columns = parseInt(columnsInput.value) || 3;
                
                // Update grid dimensions display
                currentRows.textContent = rows;
                currentCols.textContent = columns;
                gridDimensions.style.display = 'flex';
            }
            
            // Debug log the dimensions
            console.log("Creating grid with dimensions:", rows, "rows ×", columns, "columns");
            
            // Show preview panel
            document.getElementById('preview-panel').style.display = 'block';
            
            // STEP 1: Calculate responsive width based on screen size
            const isMobile = window.innerWidth <= 768;
            const RENDER_WIDTH = isMobile ? Math.min(window.innerWidth - 40, 600) : 600;
            const aspectRatio = uploadedImage.height / uploadedImage.width;
            const RENDER_HEIGHT = RENDER_WIDTH * aspectRatio;
            
            const renderCanvas = document.createElement('canvas');
            renderCanvas.width = RENDER_WIDTH;
            renderCanvas.height = RENDER_HEIGHT;
            const renderCtx = renderCanvas.getContext('2d');
            
            // Clear the canvas with a solid background
            renderCtx.fillStyle = '#ffffff';
            renderCtx.fillRect(0, 0, RENDER_WIDTH, RENDER_HEIGHT);
            
            // Draw image on canvas with high quality settings
            renderCtx.imageSmoothingEnabled = true;
            renderCtx.imageSmoothingQuality = 'high';
            renderCtx.drawImage(uploadedImage, 0, 0, RENDER_WIDTH, RENDER_HEIGHT);
            
            // Set container dimensions to match the canvas
            container.style.width = `${RENDER_WIDTH}px`;
            container.style.height = `${RENDER_HEIGHT}px`;
            container.style.display = 'block';
            container.style.position = 'relative';
            container.style.overflow = 'hidden';
            container.style.maxWidth = '100%';
            container.style.margin = '0 auto';
            
            // Store the canvas as a data-URL and apply as background
            const renderedImageUrl = renderCanvas.toDataURL('image/png');
            window.renderedImageUrl = renderedImageUrl; // Store globally for debugging
            
            // Clear previous grid contents
            gridContainer.innerHTML = '';
            gridContainer.style.width = '100%';
            gridContainer.style.height = '100%';
            gridContainer.style.position = 'relative';
            gridContainer.style.backgroundImage = `url(${renderedImageUrl})`;
            gridContainer.style.backgroundSize = 'cover';
            gridContainer.style.backgroundPosition = 'center';
            
            // Store references for the image processing
            window.gridRenderWidth = RENDER_WIDTH;
            window.gridRenderHeight = RENDER_HEIGHT;
            window.originalWidth = uploadedImage.width;
            window.originalHeight = uploadedImage.height;
            
            console.log('Original image:', 
                'width =', uploadedImage.width, 
                'height =', uploadedImage.height,
                'render width =', RENDER_WIDTH,
                'render height =', RENDER_HEIGHT
            );
            
            // Clear existing arrays
            horizontalLines = [];
            verticalLines = [];
            
            // STEP 2: Create the grid with precise measurements
            // Create horizontal lines at exact positions
            for (let i = 1; i < rows; i++) {
                const yPos = Math.floor((i / rows) * RENDER_HEIGHT);
                const percentage = (yPos / RENDER_HEIGHT) * 100;
                
                const line = document.createElement('div');
                line.className = 'grid-line horizontal-line';
                line.style.top = `${percentage}%`;
                line.style.left = '0';
                line.dataset.index = i - 1;
                line.dataset.yPixel = yPos;
                
                // Make line draggable
                line.addEventListener('mousedown', startDragHorizontal);
                line.addEventListener('touchstart', startDragHorizontalTouch, { passive: false });
                
                gridContainer.appendChild(line);
                horizontalLines.push(line);
            }
            
            // Create vertical lines at exact positions
            for (let i = 1; i < columns; i++) {
                const xPos = Math.floor((i / columns) * RENDER_WIDTH);
                const percentage = (xPos / RENDER_WIDTH) * 100;
                
                const line = document.createElement('div');
                line.className = 'grid-line vertical-line';
                line.style.left = `${percentage}%`;
                line.style.top = '0';
                line.dataset.index = i - 1;
                line.dataset.xPixel = xPos;
                
                // Make line draggable
                line.addEventListener('mousedown', startDragVertical);
                line.addEventListener('touchstart', startDragVerticalTouch, { passive: false });
                
                gridContainer.appendChild(line);
                verticalLines.push(line);
            }
            
            // Create grid cells
            createCells(rows, columns);
            
            // Show download button
            downloadContainer.style.display = 'grid';
            
            // Reset download buttons visibility
            showAllDownloads = false;
            updateDownloadButtonsUI();
            gridContainer.classList.remove('show-all-downloads');
        }
        
        // Create the grid cells with precise positions
        function createCells(rows, columns) {
            // Debug log received dimensions
            console.log("Creating cells with dimensions:", rows, "rows ×", columns, "columns");
            
            // Calculate exact positions in pixels
            const rowPositions = [0];
            horizontalLines.forEach(line => {
                rowPositions.push(parseInt(line.dataset.yPixel, 10));
            });
            rowPositions.push(window.gridRenderHeight);
            
            const colPositions = [0];
            verticalLines.forEach(line => {
                colPositions.push(parseInt(line.dataset.xPixel, 10));
            });
            colPositions.push(window.gridRenderWidth);
            
            // Log the calculated positions for debugging
            console.log('Grid positions (pixels):', 
                'rows =', rowPositions, 
                'columns =', colPositions
            );
            
            // Create cells with exact pixel positions
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < columns; col++) {
                    const top = rowPositions[row];
                    const left = colPositions[col];
                    const bottom = rowPositions[row + 1];
                    const right = colPositions[col + 1];
                    
                    const height = bottom - top;
                    const width = right - left;
                    
                    // Calculate percentages for display
                    const topPercent = (top / window.gridRenderHeight) * 100;
                    const leftPercent = (left / window.gridRenderWidth) * 100;
                    const heightPercent = (height / window.gridRenderHeight) * 100;
                    const widthPercent = (width / window.gridRenderWidth) * 100;
                    
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.style.top = `${topPercent}%`;
                    cell.style.left = `${leftPercent}%`;
                    cell.style.height = `${heightPercent}%`;
                    cell.style.width = `${widthPercent}%`;
                    
                    // Store exact pixel coordinates
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.dataset.topPixel = top;
                    cell.dataset.leftPixel = left;
                    cell.dataset.heightPixel = height;
                    cell.dataset.widthPixel = width;
                    
                    // Log cell coordinates for debugging
                    console.log(`Cell ${row+1}x${col+1}:`, 
                        'pixels:', top, left, height, width,
                        'percent:', topPercent.toFixed(2), leftPercent.toFixed(2), heightPercent.toFixed(2), widthPercent.toFixed(2)
                    );
                    
                    // Add cell number
                    const cellNumber = document.createElement('div');
                    cellNumber.className = 'cell-number';
                    cellNumber.textContent = `${row+1}×${col+1}`;
                    cell.appendChild(cellNumber);
                    
                    // Add download button
                    const downloadBtn = document.createElement('div');
                    downloadBtn.className = 'cell-download';
                    downloadBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    `;
                    downloadBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        downloadSingleCell(cell);
                    });
                    cell.appendChild(downloadBtn);
                    
                    gridContainer.appendChild(cell);
                }
            }
        }
        
        // Drag handlers
        function startDragHorizontal(e) {
            e.preventDefault();
            const line = e.target;
            const index = parseInt(line.dataset.index);
            const containerRect = container.getBoundingClientRect();
            
            function moveHandler(moveEvent) {
                const y = moveEvent.clientY - containerRect.top;
                const percentage = (y / containerRect.height) * 100;
                
                // Don't allow lines to cross
                const minY = index === 0 ? 5 : parseFloat(horizontalLines[index - 1].style.top) + 5;
                const maxY = index === horizontalLines.length - 1 ? 95 : parseFloat(horizontalLines[index + 1].style.top) - 5;
                
                const newPos = Math.max(minY, Math.min(maxY, percentage));
                line.style.top = `${newPos}%`;
                
                // Update cells without recreating grid lines
                updateCellsWithoutRecreatingGrid();
                
                // Maintain download buttons visibility state
                if (showAllDownloads) {
                    gridContainer.classList.add('show-all-downloads');
                }
            }
            
            function upHandler() {
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('mouseup', upHandler);
            }
            
            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', upHandler);
        }
        
        function startDragVertical(e) {
            e.preventDefault();
            const line = e.target;
            const index = parseInt(line.dataset.index);
            const containerRect = container.getBoundingClientRect();
            
            function moveHandler(moveEvent) {
                const x = moveEvent.clientX - containerRect.left;
                const percentage = (x / containerRect.width) * 100;
                
                // Don't allow lines to cross
                const minX = index === 0 ? 5 : parseFloat(verticalLines[index - 1].style.left) + 5;
                const maxX = index === verticalLines.length - 1 ? 95 : parseFloat(verticalLines[index + 1].style.left) - 5;
                
                const newPos = Math.max(minX, Math.min(maxX, percentage));
                line.style.left = `${newPos}%`;
                
                // Update cells without recreating grid lines
                updateCellsWithoutRecreatingGrid();
                
                // Maintain download buttons visibility state
                if (showAllDownloads) {
                    gridContainer.classList.add('show-all-downloads');
                }
            }
            
            function upHandler() {
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('mouseup', upHandler);
            }
            
            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', upHandler);
        }
        
        // Touch event handlers
        function startDragHorizontalTouch(e) {
            e.preventDefault();
            const line = e.target;
            const index = parseInt(line.dataset.index);
            const containerRect = container.getBoundingClientRect();
            
            function moveHandler(moveEvent) {
                const touch = moveEvent.touches[0];
                const y = touch.clientY - containerRect.top;
                const percentage = (y / containerRect.height) * 100;
                
                // Don't allow lines to cross
                const minY = index === 0 ? 5 : parseFloat(horizontalLines[index - 1].style.top) + 5;
                const maxY = index === horizontalLines.length - 1 ? 95 : parseFloat(horizontalLines[index + 1].style.top) - 5;
                
                const newPos = Math.max(minY, Math.min(maxY, percentage));
                line.style.top = `${newPos}%`;
                
                // Update cells without recreating grid lines
                updateCellsWithoutRecreatingGrid();
                
                // Maintain download buttons visibility state
                if (showAllDownloads) {
                    gridContainer.classList.add('show-all-downloads');
                }
            }
            
            function upHandler() {
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('touchend', upHandler);
            }
            
            document.addEventListener('touchmove', moveHandler, { passive: false });
            document.addEventListener('touchend', upHandler);
        }
        
        function startDragVerticalTouch(e) {
            e.preventDefault();
            const line = e.target;
            const index = parseInt(line.dataset.index);
            const containerRect = container.getBoundingClientRect();
            
            function moveHandler(moveEvent) {
                const touch = moveEvent.touches[0];
                const x = touch.clientX - containerRect.left;
                const percentage = (x / containerRect.width) * 100;
                
                // Don't allow lines to cross
                const minX = index === 0 ? 5 : parseFloat(verticalLines[index - 1].style.left) + 5;
                const maxX = index === verticalLines.length - 1 ? 95 : parseFloat(verticalLines[index + 1].style.left) - 5;
                
                const newPos = Math.max(minX, Math.min(maxX, percentage));
                line.style.left = `${newPos}%`;
                
                // Update cells without recreating grid lines
                updateCellsWithoutRecreatingGrid();
                
                // Maintain download buttons visibility state
                if (showAllDownloads) {
                    gridContainer.classList.add('show-all-downloads');
                }
            }
            
            function upHandler() {
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('touchend', upHandler);
            }
            
            document.addEventListener('touchmove', moveHandler, { passive: false });
            document.addEventListener('touchend', upHandler);
        }
        
        // Update cells after dragging grid lines
        function updateCellsWithoutRecreatingGrid() {
            // Calculate exact positions in pixels
            const rowPositions = [0];
            horizontalLines.forEach(line => {
                // Get the actual pixel position from style.top percentage
                const percentage = parseFloat(line.style.top);
                const pixelPos = Math.round((percentage / 100) * window.gridRenderHeight);
                line.dataset.yPixel = pixelPos;
                rowPositions.push(pixelPos);
            });
            rowPositions.push(window.gridRenderHeight);
            
            const colPositions = [0];
            verticalLines.forEach(line => {
                // Get the actual pixel position from style.left percentage
                const percentage = parseFloat(line.style.left);
                const pixelPos = Math.round((percentage / 100) * window.gridRenderWidth);
                line.dataset.xPixel = pixelPos;
                colPositions.push(pixelPos);
            });
            colPositions.push(window.gridRenderWidth);
            
            // Clear existing cells
            const existingCells = document.querySelectorAll('.grid-cell');
            existingCells.forEach(cell => cell.remove());
            
            const rows = horizontalLines.length + 1;
            const cols = verticalLines.length + 1;
            
            // Create cells with updated positions
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const top = rowPositions[row];
                    const left = colPositions[col];
                    const bottom = rowPositions[row + 1];
                    const right = colPositions[col + 1];
                    
                    const height = bottom - top;
                    const width = right - left;
                    
                    // Calculate percentages for display
                    const topPercent = (top / window.gridRenderHeight) * 100;
                    const leftPercent = (left / window.gridRenderWidth) * 100;
                    const heightPercent = (height / window.gridRenderHeight) * 100;
                    const widthPercent = (width / window.gridRenderWidth) * 100;
                    
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.style.top = `${topPercent}%`;
                    cell.style.left = `${leftPercent}%`;
                    cell.style.height = `${heightPercent}%`;
                    cell.style.width = `${widthPercent}%`;
                    
                    // Store exact pixel coordinates
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.dataset.topPixel = top;
                    cell.dataset.leftPixel = left;
                    cell.dataset.heightPixel = height;
                    cell.dataset.widthPixel = width;
                    
                    // Add cell number
                    const cellNumber = document.createElement('div');
                    cellNumber.className = 'cell-number';
                    cellNumber.textContent = `${row+1}×${col+1}`;
                    cell.appendChild(cellNumber);
                    
                    // Add download button
                    const downloadBtn = document.createElement('div');
                    downloadBtn.className = 'cell-download';
                    downloadBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    `;
                    downloadBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        downloadSingleCell(cell);
                    });
                    cell.appendChild(downloadBtn);
                    
                    gridContainer.appendChild(cell);
                }
            }
        }
        
        // Toggle download buttons visibility
        function toggleDownloadButtons() {
            showAllDownloads = !showAllDownloads;
            
            if (showAllDownloads) {
                gridContainer.classList.add('show-all-downloads');
                showDownloadsBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="8" y1="12" x2="16" y2="12"></line>
                    </svg>
                    Hide Download Buttons
                `;
            } else {
                gridContainer.classList.remove('show-all-downloads');
                showDownloadsBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="8" y1="12" x2="16" y2="12"></line>
                        <line x1="12" y1="8" x2="12" y2="16"></line>
                    </svg>
                    Show Download Buttons
                `;
            }
        }
        
        function updateDownloadButtonsUI() {
            showDownloadsBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                </svg>
                Show Download Buttons
            `;
        }
        
        // Download single cell
        function downloadSingleCell(cell) {
            try {
                // Get exact pixel positions from cell dataset
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                const topPixel = parseInt(cell.dataset.topPixel);
                const leftPixel = parseInt(cell.dataset.leftPixel);
                const heightPixel = parseInt(cell.dataset.heightPixel);
                const widthPixel = parseInt(cell.dataset.widthPixel);
                
                // Log the exact crop dimensions for debugging
                console.log(`Downloading cell ${row+1}x${col+1}:`, 
                    'Rendered coords (px):', leftPixel, topPixel, widthPixel, heightPixel,
                    'Original dimensions:', uploadedImage.width, uploadedImage.height,
                    'Render dimensions:', window.gridRenderWidth, window.gridRenderHeight
                );
                
                // Calculate scale factor between rendered grid and original image
                const scaleX = uploadedImage.width / window.gridRenderWidth;
                const scaleY = uploadedImage.height / window.gridRenderHeight;
                
                // Calculate source coordinates in the original image - EXACT PIXELS
                const sourceX = Math.round(leftPixel * scaleX);
                const sourceY = Math.round(topPixel * scaleY);
                const sourceWidth = Math.round(widthPixel * scaleX);
                const sourceHeight = Math.round(heightPixel * scaleY);
                
                // Log the calculated source coordinates for debugging
                console.log('Cropping from original image:', 
                    'source coordinates:', sourceX, sourceY, sourceWidth, sourceHeight,
                    'scale factors:', scaleX, scaleY
                );
                
                // Create canvas for the output
                const canvas = document.createElement('canvas');
                canvas.width = sourceWidth;
                canvas.height = sourceHeight;
                const ctx = canvas.getContext('2d');
                
                // Use high-quality rendering
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                // Draw the exact region from the original image
                ctx.drawImage(
                    uploadedImage,
                    sourceX, sourceY, sourceWidth, sourceHeight,
                    0, 0, sourceWidth, sourceHeight
                );
                
                // Create download link
                const link = document.createElement('a');
                link.download = `grid_${row+1}x${col+1}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                return true;
            } catch (error) {
                console.error("Error generating image:", error);
                alert("There was an error creating this image. Please try again.");
                return false;
            }
        }
        
        // Download all cells as ZIP
        function downloadAllCells() {
            const cells = document.querySelectorAll('.grid-cell');
            
            if (cells.length === 0) {
                alert("No grid cells to download. Please create a grid first.");
                return;
            }
            
            // Show loading indicator
            loadingIndicator.style.display = 'flex';
            
            try {
                // Calculate scale factor between rendered grid and original image
                const scaleX = uploadedImage.width / window.gridRenderWidth;
                const scaleY = uploadedImage.height / window.gridRenderHeight;
                
                console.log('Downloading all cells:', 
                    'Original dimensions:', uploadedImage.width, uploadedImage.height,
                    'Render dimensions:', window.gridRenderWidth, window.gridRenderHeight,
                    'Scale factors:', scaleX, scaleY
                );
                
                // Create a new ZIP file
                const zip = new JSZip();
                
                // Process each cell and add to ZIP
                let processedCount = 0;
                
                cells.forEach((cell, index) => {
                    // Get exact pixel positions from cell dataset
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    const topPixel = parseInt(cell.dataset.topPixel);
                    const leftPixel = parseInt(cell.dataset.leftPixel);
                    const heightPixel = parseInt(cell.dataset.heightPixel);
                    const widthPixel = parseInt(cell.dataset.widthPixel);
                    
                    // Calculate source coordinates in the original image - EXACT PIXELS
                    const sourceX = Math.round(leftPixel * scaleX);
                    const sourceY = Math.round(topPixel * scaleY);
                    const sourceWidth = Math.round(widthPixel * scaleX);
                    const sourceHeight = Math.round(heightPixel * scaleY);
                    
                    // Log for debugging
                    console.log(`ZIP: Cell ${row+1}x${col+1}:`, 
                        'Source coordinates:', sourceX, sourceY, sourceWidth, sourceHeight
                    );
                    
                    // Create canvas for the output
                    const canvas = document.createElement('canvas');
                    canvas.width = sourceWidth;
                    canvas.height = sourceHeight;
                    const ctx = canvas.getContext('2d');
                    
                    // Use high-quality rendering
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    // Draw the exact region from the original image
                    ctx.drawImage(
                        uploadedImage,
                        sourceX, sourceY, sourceWidth, sourceHeight,
                        0, 0, sourceWidth, sourceHeight
                    );
                    
                    // Convert to blob and add to ZIP
                    canvas.toBlob(function(blob) {
                        // Add the image to the ZIP
                        zip.file(`grid_${row+1}x${col+1}.png`, blob);
                        
                        processedCount++;
                        
                        // Update loading text
                        loadingIndicator.querySelector('.loading-text').textContent = 
                            `Processing image ${processedCount} of ${cells.length}...`;
                        
                        // Generate and download the ZIP when all cells are processed
                        if (processedCount === cells.length) {
                            loadingIndicator.querySelector('.loading-text').textContent = 
                                'Creating ZIP file...';
                            
                            zip.generateAsync({type: 'blob'}).then(function(content) {
                                saveAs(content, 'grid_images.zip');
                                loadingIndicator.style.display = 'none';
                            });
                        }
                    });
                });
            } catch (error) {
                console.error("Error generating ZIP:", error);
                alert("There was an error creating the ZIP file. Please try again.");
                loadingIndicator.style.display = 'none';
            }
        }
        
        // Update the document.ready function to include the sample button
        document.addEventListener('DOMContentLoaded', function() {
            const sampleBtn = document.getElementById('sample-btn');
            sampleBtn.addEventListener('click', useSampleImage);
        });
        
        // Function to create a sample grid image 
        function createSampleGridImage(width = 400, height = 400, userRows = 3, userCols = 4) {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // Create a sample grid with colored blocks - using user-specified rows and columns
            const cellWidth = width / userCols;
            const cellHeight = height / userRows;
            const colors = [
                '#ff6b6b', '#ff922b', '#ffd43b', 
                '#a9e34b', '#69db7c', '#3bc9db', 
                '#748ffc', '#9775fa', '#f783ac',
                '#da77f2', '#4dabf7', '#343a40'
            ];
            
            // Fill background
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid cells with different colors - using user-specified rows and columns
            let colorIndex = 0;
            for (let row = 0; row < userRows; row++) {
                for (let col = 0; col < userCols; col++) {
                    ctx.fillStyle = colors[colorIndex % colors.length];
                    ctx.fillRect(
                        col * cellWidth, 
                        row * cellHeight, 
                        cellWidth, 
                        cellHeight
                    );
                    
                    // Add cell number
                    ctx.fillStyle = 'rgba(255,255,255,0.8)';
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(
                        `${row+1}×${col+1}`, 
                        col * cellWidth + cellWidth/2, 
                        row * cellHeight + cellHeight/2
                    );
                    
                    colorIndex++;
                }
            }
            
            return canvas.toDataURL('image/png');
        }
        
        // Function to use the sample image
        function useSampleImage() {
            try {
                // Get the user-specified rows and columns
                const userRows = parseInt(rowsInput.value) || 3;
                const userColumns = parseInt(columnsInput.value) || 3;
                
                // Create a programmatically generated sample image with user's dimensions
                const sampleDataUrl = createSampleGridImage(600, 450, userRows, userColumns);
                
                // Create a new image element
                uploadedImage = new Image();
                uploadedImage.onload = function() {
                    // Clear previous preview
                    imagePreview.innerHTML = '';
                    imagePreview.classList.remove('no-image');
                    
                    // Create preview image
                    const img = document.createElement('img');
                    img.src = sampleDataUrl;
                    img.className = 'preview-image';
                    imagePreview.appendChild(img);
                    
                    // Update the image preview appearance
                    imagePreview.style.padding = '0';
                    imagePreview.style.border = 'none';
                    imagePreview.style.backgroundColor = 'transparent';
                    
                    // Automatically create grid with these dimensions
                    createGrid(false);
                };
                
                // Use the data URL to avoid CORS issues
                uploadedImage.src = sampleDataUrl;
                
            } catch (error) {
                console.error("Error creating sample image:", error);
                alert("There was an error loading the sample image. Please try uploading your own image instead.");
            }
        }
    </script>
</body>
</html>